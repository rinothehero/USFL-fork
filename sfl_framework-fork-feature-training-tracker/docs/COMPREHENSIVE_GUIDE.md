# SFL Framework & USFL ì¢…í•© ê°€ì´ë“œ

> **Split Federated Learning í†µí•© í”„ë ˆì„ì›Œí¬**ì™€ **USFL (Unified Split Federated Learning)** ê¸°ë²•ì˜ ì™„ì „í•œ ì´í•´ë¥¼ ìœ„í•œ ì¢…í•© ë¬¸ì„œ

---

## ğŸ“š ëª©ì°¨

### Part 1: í”„ë ˆì„ì›Œí¬ ê°œìš”
1. [í”„ë ˆì„ì›Œí¬ ì†Œê°œ](#1-í”„ë ˆì„ì›Œí¬-ì†Œê°œ)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡°](#2-í”„ë¡œì íŠ¸-êµ¬ì¡°)
3. [ì‹¤í–‰ ëª¨ë“œ](#3-ì‹¤í–‰-ëª¨ë“œ)
4. [ì§€ì› í•™ìŠµ ë°©ë²•](#4-ì§€ì›-í•™ìŠµ-ë°©ë²•)

### Part 2: í•µì‹¬ ì•„í‚¤í…ì²˜
5. [Stage Organizer íŒ¨í„´](#5-stage-organizer-íŒ¨í„´)
6. [í•µì‹¬ ì»´í¬ë„ŒíŠ¸](#6-í•µì‹¬-ì»´í¬ë„ŒíŠ¸)
7. [ë°ì´í„° ë¶„í¬ ì „ëµ](#7-ë°ì´í„°-ë¶„í¬-ì „ëµ)

### Part 3: USFL ì™„ì „ ë¶„ì„
8. [USFL ê°œìš”](#8-usfl-ê°œìš”)
9. [Data Balancing Strategy](#9-data-balancing-strategy)
10. [Gradient Shuffle](#10-gradient-shuffle)
11. [USFL Selector](#11-usfl-selector)
12. [USFL Aggregator](#12-usfl-aggregator)
13. [Dynamic Batch Scheduler](#13-dynamic-batch-scheduler)
14. [Cumulative Usage Tracking](#14-cumulative-usage-tracking)

### Part 4: ì‹¤í–‰ ë° í™œìš©
15. [ì„¤ì • íŒŒë¼ë¯¸í„° ë ˆí¼ëŸ°ìŠ¤](#15-ì„¤ì •-íŒŒë¼ë¯¸í„°-ë ˆí¼ëŸ°ìŠ¤)
16. [ì‹¤í—˜ ì‹¤í–‰ ê°€ì´ë“œ](#16-ì‹¤í—˜-ì‹¤í–‰-ê°€ì´ë“œ)

---

# Part 1: í”„ë ˆì„ì›Œí¬ ê°œìš”

## 1. í”„ë ˆì„ì›Œí¬ ì†Œê°œ

ì´ í”„ë ˆì„ì›Œí¬ëŠ” **Federated Learning (FL)**ê³¼ **Split Federated Learning (SFL)**ì˜ ë‹¤ì–‘í•œ ê¸°ë²•ë“¤ì„ **Simulation**ê³¼ **Real Device (Emulation)** í™˜ê²½ ëª¨ë‘ì—ì„œ ì‹¤í—˜í•  ìˆ˜ ìˆëŠ” **í†µí•© ì—°êµ¬ í”Œë«í¼**ì…ë‹ˆë‹¤.

### 1.1 ì£¼ìš” íŠ¹ì§•

| íŠ¹ì§• | ì„¤ëª… |
|------|------|
| **ë‹¤ì–‘í•œ í•™ìŠµ ë°©ë²•** | FL, SFL, USFL ë“± 13ê°€ì§€ ë°©ë²• ì§€ì› |
| **ìœ ì—°í•œ ì‹¤í–‰ ëª¨ë“œ** | Simulation (In-Memory) / Emulation (Real Process) |
| **í™•ì¥ ê°€ëŠ¥í•œ ì„¤ê³„** | ëª¨ë“ˆí™”ëœ Stage Organizer íŒ¨í„´ |
| **Non-IID ì§€ì›** | Dirichlet, Label, Shard-Dirichlet ë¶„í¬ |
| **ëª¨ë¸ ë¶„í• ** | Layer Name, Ratio Param, Ratio Layer ì „ëµ |

### 1.2 í•µì‹¬ ê°œë…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Federated Learning (FL)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Client 1    Client 2    Client 3    ...    Client N        â”‚   â”‚
â”‚  â”‚     â†“           â†“           â†“                 â†“             â”‚   â”‚
â”‚  â”‚  [Full Model] [Full Model] [Full Model]    [Full Model]     â”‚   â”‚
â”‚  â”‚     â†“           â†“           â†“                 â†“             â”‚   â”‚
â”‚  â”‚  Local Train  Local Train  Local Train    Local Train       â”‚   â”‚
â”‚  â”‚     â†“           â†“           â†“                 â†“             â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚                        â†“ Aggregate                          â”‚   â”‚
â”‚  â”‚                    Global Model                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Split Federated Learning (SFL)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Client 1      Client 2      Client 3      ...    Client N    â”‚ â”‚
â”‚  â”‚  [Client Model][Client Model][Client Model]    [Client Model] â”‚ â”‚
â”‚  â”‚      â†“             â†“             â†“                 â†“          â”‚ â”‚
â”‚  â”‚  Forward       Forward       Forward           Forward        â”‚ â”‚
â”‚  â”‚      â†“             â†“             â†“                 â†“          â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Activations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚                        â†“                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                    SERVER                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚              [Server Model (Top)]                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                      â†“                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚               Forward + Loss                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                      â†“                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                  Backward                                â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                        â†“                                      â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Gradients â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚      â†“             â†“             â†“                 â†“          â”‚ â”‚
â”‚  â”‚  Backward      Backward      Backward          Backward       â”‚ â”‚
â”‚  â”‚  [Client Model][Client Model][Client Model]    [Client Model] â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. í”„ë¡œì íŠ¸ êµ¬ì¡°

```
sfl_framework-fork/
â”œâ”€â”€ simulation.py              # Simulation ì‹¤í–‰ê¸° (In-Memory)
â”œâ”€â”€ emulation.py               # Emulation ì‹¤í–‰ê¸° (Real Process)
â”œâ”€â”€ requirements.txt           # ì˜ì¡´ì„± íŒ¨í‚¤ì§€
â”‚
â”œâ”€â”€ server/                    # â•â•â• ì„œë²„ ì¸¡ êµ¬í˜„ â•â•â•
â”‚   â”œâ”€â”€ main.py               # ì„œë²„ ì§„ì…ì , ì„¤ì • ê²€ì¦
â”‚   â”œâ”€â”€ server.py             # ì„œë²„ í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ server_args.py        # ì„¤ì • Config ë°ì´í„°í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ simulation_server.py  # Simulationìš© ì„œë²„
â”‚   â””â”€â”€ modules/
â”‚       â”œâ”€â”€ dataset/          # ë°ì´í„°ì…‹ (CIFAR, MNIST, GLUE...)
â”‚       â”œâ”€â”€ model/            # ëª¨ë¸ ì •ì˜ (ResNet, VGG, AlexNet...)
â”‚       â”œâ”€â”€ global_dict/      # ì „ì—­ ìƒíƒœ ê´€ë¦¬
â”‚       â”œâ”€â”€ ws/               # WebSocket í†µì‹ 
â”‚       â””â”€â”€ trainer/          # â•â•â• í•™ìŠµ ê´€ë ¨ í•µì‹¬ ëª¨ë“ˆ â•â•â•
â”‚           â”œâ”€â”€ aggregator/   # ëª¨ë¸ ì§‘ê³„ (FedAvg, USFL...)
â”‚           â”‚   â”œâ”€â”€ fedavg_aggregator.py
â”‚           â”‚   â””â”€â”€ usfl_aggregator.py     â˜…
â”‚           â”œâ”€â”€ seletor/      # í´ë¼ì´ì–¸íŠ¸ ì„ íƒ
â”‚           â”‚   â”œâ”€â”€ uniform_selector.py
â”‚           â”‚   â””â”€â”€ usfl_selector.py       â˜…
â”‚           â”œâ”€â”€ distributer/  # ë°ì´í„° ë¶„ë°°
â”‚           â”‚   â””â”€â”€ shard_dirichlet_distributer.py
â”‚           â”œâ”€â”€ splitter/     # ëª¨ë¸ ë¶„í• 
â”‚           â”œâ”€â”€ scheduler/    # ë°°ì¹˜ ìŠ¤ì¼€ì¤„ëŸ¬
â”‚           â”‚   â””â”€â”€ batch_scheduler.py     â˜…
â”‚           â”œâ”€â”€ stage/        # Stage Organizer
â”‚           â”‚   â”œâ”€â”€ fl_stage_organizer.py
â”‚           â”‚   â”œâ”€â”€ sfl_stage_organizer.py
â”‚           â”‚   â””â”€â”€ usfl_stage_organizer.py â˜…
â”‚           â””â”€â”€ utils/        # ìœ í‹¸ë¦¬í‹°
â”‚               â”œâ”€â”€ usfl_logger.py
â”‚               â””â”€â”€ training_tracker.py
â”‚
â”œâ”€â”€ client/                    # â•â•â• í´ë¼ì´ì–¸íŠ¸ ì¸¡ êµ¬í˜„ â•â•â•
â”‚   â”œâ”€â”€ main.py               # í´ë¼ì´ì–¸íŠ¸ ì§„ì…ì 
â”‚   â”œâ”€â”€ client.py             # í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ client_args.py        # í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
â”‚   â”œâ”€â”€ simulation_client.py  # Simulationìš© í´ë¼ì´ì–¸íŠ¸
â”‚   â””â”€â”€ modules/
â”‚       â”œâ”€â”€ dataset/          # í´ë¼ì´ì–¸íŠ¸ ë°ì´í„°ì…‹
â”‚       â”‚   â””â”€â”€ maskable_dataset.py   â˜… (Balancing ì ìš©)
â”‚       â”œâ”€â”€ model/            # í´ë¼ì´ì–¸íŠ¸ ëª¨ë¸
â”‚       â”œâ”€â”€ ws/               # WebSocket ì—°ê²°
â”‚       â””â”€â”€ trainer/
â”‚           â”œâ”€â”€ model_trainer/
â”‚           â”‚   â””â”€â”€ usfl_model_trainer.py  â˜…
â”‚           â””â”€â”€ stage/
â”‚               â””â”€â”€ usfl_stage_organizer.py â˜…
â”‚
â””â”€â”€ utils/                     # ê³µìš© ìœ í‹¸ë¦¬í‹°
    â””â”€â”€ g_measurement.py      # Gradient ì¸¡ì • ë„êµ¬

â˜… = USFL í•µì‹¬ íŒŒì¼
```

---

## 3. ì‹¤í–‰ ëª¨ë“œ

### 3.1 Simulation Mode (`simulation.py`)

```python
# In-Memory í†µì‹ ìœ¼ë¡œ ë¹ ë¥¸ ì‹¤í—˜
async def run_simulation(server_args, client_args_list):
    # ë©”ëª¨ë¦¬ ë‚´ ì—°ê²° ê°ì²´ ìƒì„±
    inmemory_server_connection = InMemoryServerConnection(...)
    inmemory_client_connections = [InMemoryClientConnection(...) for ...]
    
    # ë¹„ë™ê¸° ë™ì‹œ ì‹¤í–‰
    await asyncio.gather(
        simulation_server.run(),
        *[client.run() for client in simulation_clients],
    )
```

**íŠ¹ì§•**:
- âœ… ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ ì—†ìŒ
- âœ… ë¹ ë¥¸ ì‹¤í—˜ ë° ë””ë²„ê¹…
- âœ… ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰

### 3.2 Emulation Mode (`emulation.py`)

ì‹¤ì œ í”„ë¡œì„¸ìŠ¤ë¡œ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë¶„ë¦¬ ì‹¤í–‰í•˜ì—¬ ì‹¤ì œ ë°°í¬ í™˜ê²½ê³¼ ìœ ì‚¬í•˜ê²Œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

**íŠ¹ì§•**:
- âœ… ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ í†µì‹  (WebSocket)
- âœ… ë¶„ì‚° í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜
- âœ… ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

---

## 4. ì§€ì› í•™ìŠµ ë°©ë²•

| Method | ìœ í˜• | ì„¤ëª… | í•µì‹¬ íŠ¹ì§• |
|--------|------|------|----------|
| `fl` | FL | Federated Learning | ì „ì²´ ëª¨ë¸ ì „ì†¡ |
| `sfl` | SFL | Split Federated Learning | Client â†’ Server í•™ìŠµ íë¦„ |
| `sfl-u` | SFL | SFL with Label Privacy | Client â†’ Server â†’ Client íë¦„ |
| `usfl` | **SFL** | **USFL (ì—°êµ¬ ì¤‘)** | **ë°ì´í„° ê· í˜•í™”, í´ë¼ì´ì–¸íŠ¸ ì„ íƒ ìµœì í™”** |
| `fitfl` | FL | FitFL (Accurate & Fast) | Hybrid Scaling, Pruning |
| `prunefl` | FL | PruneFL | ì ì§„ì  Pruning |
| `fedsparsify` | FL | FedSparsify | Sparse í•™ìŠµ |
| `nestfl` | FL | NestFL | Nested êµ¬ì¡° |
| `fedprox` | FL | FedProx | Proximal Term ì •ê·œí™” |
| `scala` | SFL | SCALA | Concatenation, Logit Adjustment |
| `fedcbs` | FL | FedCBS | Class-Balanced Selection |
| `sflprox` | SFL | SFLProx | SFL + Proximal Term |
| `cl` | - | Centralized Learning | ì¤‘ì•™ ì§‘ì¤‘ í•™ìŠµ (ë² ì´ìŠ¤ë¼ì¸) |

---

# Part 2: í•µì‹¬ ì•„í‚¤í…ì²˜

## 5. Stage Organizer íŒ¨í„´

ëª¨ë“  í•™ìŠµ ë°©ë²•ì€ **3-Stage íŒ¨í„´**ì„ ë”°ë¦…ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ROUND LIFECYCLE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    PRE-ROUND                                 â”‚   â”‚
â”‚  â”‚  â€¢ í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ìˆ˜ì§‘                                        â”‚   â”‚
â”‚  â”‚  â€¢ í´ë¼ì´ì–¸íŠ¸ ì„ íƒ (Selector)                                 â”‚   â”‚
â”‚  â”‚  â€¢ ëª¨ë¸ ë¶„í•  (Splitter) - SFL ì „ìš©                            â”‚   â”‚
â”‚  â”‚  â€¢ ê¸€ë¡œë²Œ ëª¨ë¸ ì „ì†¡                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     IN-ROUND                                 â”‚   â”‚
â”‚  â”‚  â€¢ [FL] í´ë¼ì´ì–¸íŠ¸ ë¡œì»¬ í•™ìŠµ ëŒ€ê¸°                              â”‚   â”‚
â”‚  â”‚  â€¢ [SFL] ì„œë²„ ì¸¡ í•™ìŠµ (Forward + Backward)                    â”‚   â”‚
â”‚  â”‚  â€¢ [SFL] Activation/Gradient êµí™˜                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    POST-ROUND                                â”‚   â”‚
â”‚  â”‚  â€¢ ëª¨ë¸ ìˆ˜ì§‘                                                  â”‚   â”‚
â”‚  â”‚  â€¢ ëª¨ë¸ ì§‘ê³„ (Aggregator)                                     â”‚   â”‚
â”‚  â”‚  â€¢ ê¸€ë¡œë²Œ ëª¨ë¸ ì—…ë°ì´íŠ¸                                        â”‚   â”‚
â”‚  â”‚  â€¢ í‰ê°€ (Accuracy ì¸¡ì •)                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì½”ë“œ íŒ¨í„´

```python
class BaseStageOrganizer:
    async def _pre_round(self, round_number: int):
        pass
    
    async def _in_round(self, round_number: int):
        pass
    
    async def _post_round(self, round_number: int):
        pass
```

---

## 6. í•µì‹¬ ì»´í¬ë„ŒíŠ¸

### 6.1 Selector (í´ë¼ì´ì–¸íŠ¸ ì„ íƒ)

| Selector | ì•Œê³ ë¦¬ì¦˜ | íŠ¹ì§• |
|----------|----------|------|
| `uniform` | ë¬´ì‘ìœ„ | ê¸°ë³¸ê°’, ë‹¨ìˆœ |
| `usfl` | Missing Label + Freshness | ë°ì´í„° ê· í˜• ê³ ë ¤ |
| `missing_class` | ëˆ„ë½ í´ë˜ìŠ¤ ìš°ì„  | ì»¤ë²„ë¦¬ì§€ ìµœì í™” |
| `fedcbs` | Class-Balanced | í´ë˜ìŠ¤ ê· í˜• ì„ íƒ |

### 6.2 Aggregator (ëª¨ë¸ ì§‘ê³„)

| Aggregator | ê°€ì¤‘ì¹˜ ë°©ì‹ | ìˆ˜ì‹ |
|------------|-------------|------|
| `fedavg` | ë°ì´í„° ì–‘ ë¹„ë¡€ | `w_j = n_j / Î£n` |
| `usfl` | Label-capped | `w_j = Î£_l (n_l/N) Â· (n_l,j/n_l)` |
| `fitfl` | Pruning ë§ˆìŠ¤í¬ ê³ ë ¤ | - |

### 6.3 Splitter (ëª¨ë¸ ë¶„í• )

| Strategy | ì„¤ëª… | ì‚¬ìš© ì˜ˆ |
|----------|------|--------|
| `layer_name` | íŠ¹ì • ë ˆì´ì–´ ì´ë¦„ìœ¼ë¡œ ë¶„í•  | `-sl layer1.1.bn2` |
| `ratio_param` | íŒŒë¼ë¯¸í„° ë¹„ìœ¨ë¡œ ë¶„í•  | `-sr 0.5` |
| `ratio_layer` | ë ˆì´ì–´ ë¹„ìœ¨ë¡œ ë¶„í•  | `-sr 0.3` |

---

## 7. ë°ì´í„° ë¶„í¬ ì „ëµ

### 7.1 Distributer ì¢…ë¥˜

| Distributer | ë¶„í¬ íŠ¹ì„± | íŒŒë¼ë¯¸í„° |
|------------|----------|----------|
| `uniform` | IID (ê· ë“±) | - |
| `dirichlet` | Non-IID (Dirichlet) | `-diri-alpha` |
| `label` | ë ˆì´ë¸” ì œí•œ | `-lpc` |
| `shard_dirichlet` | **Shard + Dirichlet** | `-diri-alpha`, `-lpc` |

### 7.2 Shard-Dirichlet (ê¶Œì¥)

USFL ì‹¤í—˜ì— ê¶Œì¥ë˜ëŠ” ë¶„í¬ ì „ëµì…ë‹ˆë‹¤.

```python
# í•µì‹¬ ë¡œì§ (shard_dirichlet_distributer.py)
class ShardDirichletDistributer:
    def distribute(self, dataset, clients):
        # 1. ê° í´ë˜ìŠ¤ë¥¼ ì •í™•íˆ ë™ì¼í•œ íšŸìˆ˜ë¡œ í´ë¼ì´ì–¸íŠ¸ì— í• ë‹¹
        total_assignments = num_clients * labels_per_client
        assignments_per_class = total_assignments // num_classes
        
        # 2. Dirichlet ë¶„í¬ë¡œ í´ë˜ìŠ¤ ë‚´ ë°ì´í„° ë¶„ë°°
        proportions = prng.dirichlet(np.repeat(alpha, len(clients_with_class)))
        
        # 3. min_require_size ë³´ì¥ì„ ìœ„í•œ ì¬ì‹œë„
        for retry in range(MAX_RETRIES):
            if min_size >= self.min_require_size:
                break
```

**íŒŒë¼ë¯¸í„° ì¡°í•© ì˜ˆì‹œ**:
```bash
-distr shard_dirichlet \
-diri-alpha 0.3 \       # ë‚®ì„ìˆ˜ë¡ Non-IID ì‹¬í™”
-lpc 2 \                # í´ë¼ì´ì–¸íŠ¸ë‹¹ 2ê°œ ë ˆì´ë¸”
-mrs 10                 # ìµœì†Œ 10ê°œ ìƒ˜í”Œ ë³´ì¥
```

---

# Part 3: USFL ì™„ì „ ë¶„ì„

## 8. USFL ê°œìš”

### 8.1 USFLì´ë€?

**USFL (Unified Split Federated Learning)**ì€ Non-IID í™˜ê²½ì—ì„œ Split Federated Learningì˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ ìƒˆë¡œìš´ ê¸°ë²•ì…ë‹ˆë‹¤.

### 8.2 í•´ê²°í•˜ê³ ì í•˜ëŠ” ë¬¸ì œ

```
Non-IID í™˜ê²½ì˜ ë¬¸ì œì :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client 1: [Cat, Cat, Cat, Dog]        â†’ Label 0, 1ì— í¸í–¥          â”‚
â”‚  Client 2: [Bird, Bird, Bird, Bird]    â†’ Label 2ì—ë§Œ ì§‘ì¤‘           â”‚
â”‚  Client 3: [Car, Car, Plane, Plane]    â†’ Label 3, 4                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ë¬¸ì œ 1: í´ë˜ìŠ¤ ë¶ˆê· í˜• â†’ ëª¨ë¸ì´ íŠ¹ì • í´ë˜ìŠ¤ì— í¸í–¥                      â”‚
â”‚  ë¬¸ì œ 2: ë°ì´í„° ë‚­ë¹„ â†’ ë§ì€ í´ë˜ìŠ¤ì˜ ë°ì´í„°ê°€ ë²„ë ¤ì§€ê±°ë‚˜ ê³¼ì†Œ ì‚¬ìš©        â”‚
â”‚  ë¬¸ì œ 3: Gradient í¸í–¥ â†’ ê° í´ë¼ì´ì–¸íŠ¸ê°€ í¸í–¥ëœ gradientë§Œ í•™ìŠµ         â”‚
â”‚  ë¬¸ì œ 4: Label Leakage â†’ ì„œë²„ì—ì„œ gradient íŒ¨í„´ìœ¼ë¡œ label ìœ ì¶” ê°€ëŠ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 USFLì˜ 6ê°€ì§€ í•µì‹¬ ê¸°ëŠ¥

| # | ê¸°ëŠ¥ | í•´ê²°í•˜ëŠ” ë¬¸ì œ | í™œì„±í™” |
|---|------|--------------|--------|
| 1 | **Data Balancing** | í´ë˜ìŠ¤ ë¶ˆê· í˜• | `-bstrat`, `-btarget` |
| 2 | **Gradient Shuffle** | Gradient í¸í–¥, Privacy | `-gs`, `-gss` |
| 3 | **USFL Selector** | í´ë¼ì´ì–¸íŠ¸ ì„ íƒ ìµœì í™” | `-s usfl` |
| 4 | **USFL Aggregator** | ì§‘ê³„ ê°€ì¤‘ì¹˜ ìµœì í™” | `-aggr usfl` |
| 5 | **Dynamic Batch Scheduler** | ë°ì´í„° ì™„ì „ í™œìš© | `-udbs` |
| 6 | **Cumulative Usage Tracking** | ë°ì´í„° ì‹ ì„ ë„ | `-ucu`, `-ufs` |

### 8.4 USFL í•µì‹¬ íŒŒì¼ êµ¬ì¡°

```
USFL êµ¬í˜„ íŒŒì¼ë“¤:

Server Side:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ usfl_stage_organizer.py (1148 lines)                               â”‚
â”‚  â”œâ”€ _pre_round():   Balancing ê³„ì‚°, í´ë¼ì´ì–¸íŠ¸ ì„ íƒ                  â”‚
â”‚  â”œâ”€ _in_round():    Gradient Shuffle, Forward/Backward             â”‚
â”‚  â””â”€ _post_round():  Aggregation, Cumulative Usage ì—…ë°ì´íŠ¸          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usfl_selector.py (575 lines)                                       â”‚
â”‚  â””â”€ select():       Missing Label + Freshness ê¸°ë°˜ ì„ íƒ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usfl_aggregator.py (98 lines)                                      â”‚
â”‚  â””â”€ aggregate():    Label-capped ê°€ì¤‘ì¹˜ ì§‘ê³„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client Side:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ usfl_stage_organizer.py (144 lines)                                â”‚
â”‚  â””â”€ _pre_round():   ë°ì´í„° í¬ê¸° ì¡°ì • ì ìš©                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ usfl_model_trainer.py (368 lines)                                  â”‚
â”‚  â””â”€ train():        Dynamic Batch ì²˜ë¦¬, Activation ì „ì†¡             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ maskable_dataset.py (125 lines)                                    â”‚
â”‚  â””â”€ update_amount_per_label(): Trimming/Replication ì‹¤ì œ ìˆ˜í–‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Data Balancing Strategy

### 9.1 ê°œë…

ì„œë²„ì—ì„œ ê° í´ë¼ì´ì–¸íŠ¸ì—ê²Œ **ì‹¤ì œë¡œ ì‚¬ìš©í•  ë°ì´í„° ì–‘**ì„ ì§€ì‹œí•˜ì—¬ í´ë˜ìŠ¤ ê· í˜•ì„ ë§ì¶¥ë‹ˆë‹¤.

### 9.2 ì„¸ ê°€ì§€ ì „ëµ

#### 9.2.1 Trimming (ê¸°ë³¸ê°’)

**ì›ë¦¬**: ê°€ì¥ ì ì€ í´ë˜ìŠ¤ì— ë§ì¶° ëª¨ë“  í´ë˜ìŠ¤ì˜ ë°ì´í„°ë¥¼ ì¶•ì†Œ

```
Before Trimming:
  Label 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (500)
  Label 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)
  Label 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (400)
  Label 3: â–ˆâ–ˆâ–ˆâ–ˆ (200)  â† min

After Trimming (min = 200):
  Label 0: â–ˆâ–ˆâ–ˆâ–ˆ (200)  â† 300 ì œê±°
  Label 1: â–ˆâ–ˆâ–ˆâ–ˆ (200)  â† 600 ì œê±°
  Label 2: â–ˆâ–ˆâ–ˆâ–ˆ (200)  â† 200 ì œê±°
  Label 3: â–ˆâ–ˆâ–ˆâ–ˆ (200)  â† ìœ ì§€
```

**ì½”ë“œ** (Line 651-686):
```python
min_dataset_size = min(global_dataset_sizes.values())
should_remove_count = {
    label: global_dataset_sizes[label] - min_dataset_size
    for label in range(num_classes)
}

for client_id in selected_clients:
    for label in range(num_classes):
        proportion = local_dataset_proportion_per_label[client_id][label]
        remove_for_client = int(should_remove_count[label] * proportion)
        client_label_counts[client_id][label] = original - remove_for_client
```

#### 9.2.2 Replication

**ì›ë¦¬**: ê°€ì¥ ë§ì€ í´ë˜ìŠ¤ì— ë§ì¶° ë¶€ì¡±í•œ í´ë˜ìŠ¤ì˜ ë°ì´í„°ë¥¼ ë³µì œ

```
Before Replication:
  Label 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (500)
  Label 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)  â† max
  Label 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (400)
  Label 3: â–ˆâ–ˆâ–ˆâ–ˆ (200)

After Replication (max = 800):
  Label 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)  â† 300 ë³µì œ
  Label 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)  â† ìœ ì§€
  Label 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)  â† 400 ë³µì œ
  Label 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)  â† 600 ë³µì œ
```

**ë³µì œ ë©”ì»¤ë‹ˆì¦˜** (MaskableDataset):
```python
# ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ ìˆœí™˜ ë³µì œ
if amount > total_indices:
    full_cycles = amount // total_indices
    remainder = amount % total_indices
    
    # ì „ì²´ ì‚¬ì´í´ ë³µì œ
    self.limited_indices.extend(indices_list * full_cycles)
    
    # ë‚˜ë¨¸ì§€ëŠ” shard_positionë¶€í„° ìˆœí™˜ ìƒ˜í”Œë§
    # â†’ ì—í­ë§ˆë‹¤ ë‹¤ë¥¸ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì–´ ë‹¤ì–‘ì„± í™•ë³´
```

#### 9.2.3 Target (Hybrid) - ê¶Œì¥

**ì›ë¦¬**: mean/median/ê³ ì •ê°’ ê¸°ì¤€ìœ¼ë¡œ ì´ˆê³¼ëŠ” Trim, ë¶€ì¡±ì€ Replicate

```
Before Target (mean = 475):
  Label 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (500)   â†’ Target 475
  Label 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (800)   â†’ Target 475
  Label 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (400)       â†’ Target 475
  Label 3: â–ˆâ–ˆâ–ˆâ–ˆ (200)           â†’ Target 475

After Target:
  Label 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (475)    â† 25 ì œê±°
  Label 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (475)    â† 325 ì œê±°
  Label 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (475)    â† 75 ë³µì œ
  Label 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (475)    â† 275 ë³µì œ
```

**ì½”ë“œ** (Line 554-611):
```python
if strategy == "target":
    if target_type == "mean":
        target_size = int(sum(sizes) / len(sizes))
    elif target_type == "median":
        target_size = int(sorted_sizes[mid])
    else:
        target_size = int(target_type)
    
    for label in range(num_classes):
        diff = global_dataset_sizes[label] - target_size
        if diff > 0:
            should_remove_count[label] = diff    # Trim
        else:
            should_add_count[label] = -diff      # Replicate
```

### 9.3 Balancing ê²°ê³¼ íë¦„

```
Server (_pre_round)                 Client (_pre_round)
       â”‚                                   â”‚
       â”‚  augmented_dataset_sizes:         â”‚
       â”‚  {                                â”‚
       â”‚    "0": {"0": 200, "1": 150},     â”‚
       â”‚    "1": {"0": 180, "1": 170},     â”‚
       â”‚  }                                â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
       â”‚                                   â”‚
       â”‚                     dataset.update_amount_per_label(sizes)
       â”‚                                   â”‚
       â”‚                     MaskableDataset:
       â”‚                     - Trimming: ì¸ë±ìŠ¤ ì œí•œ
       â”‚                     - Replication: ì¸ë±ìŠ¤ ë³µì œ
```

---

## 10. Gradient Shuffle

### 10.1 ê°œë…

ì„œë²„ì—ì„œ backward í›„ ê³„ì‚°ëœ gradientë¥¼ **ì…”í”Œí•˜ì—¬** í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•©ë‹ˆë‹¤.

### 10.2 í•„ìš”ì„±

```
Without Shuffle:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client 1 (Label 0, 1)  â†â”€â”€â”€â”€ grad for Label 0, 1 samples    â”‚
â”‚  Client 2 (Label 2, 3)  â†â”€â”€â”€â”€ grad for Label 2, 3 samples    â”‚
â”‚  Client 3 (Label 4, 5)  â†â”€â”€â”€â”€ grad for Label 4, 5 samples    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ë¬¸ì œ: ê° í´ë¼ì´ì–¸íŠ¸ê°€ ìì‹ ì˜ labelì— ëŒ€í•œ gradientë§Œ ë°›ìŒ      â”‚
â”‚       â†’ í¸í–¥ëœ í•™ìŠµ, Label Leakage                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

With Shuffle:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client 1  â†â”€â”€â”€â”€ grad from Label 0,2,4,1,3,5 (mixed)         â”‚
â”‚  Client 2  â†â”€â”€â”€â”€ grad from Label 1,3,5,0,2,4 (mixed)         â”‚
â”‚  Client 3  â†â”€â”€â”€â”€ grad from Label 2,4,0,1,3,5 (mixed)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  í•´ê²°: ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ì–‘í•œ labelì˜ gradient í•™ìŠµ           â”‚
â”‚       â†’ ê· í˜• í•™ìŠµ, Privacy ë³´í˜¸                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.3 ë„¤ ê°€ì§€ ì „ëµ

#### 10.3.1 Random (`-gss random`)

ê°€ì¥ ë‹¨ìˆœí•œ ë°©ì‹ìœ¼ë¡œ gradient ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ìŠµë‹ˆë‹¤.

```python
perm = torch.randperm(grad.size(0))
grad = grad[perm]
```

#### 10.3.2 Inplace (`-gss inplace`)

**í´ë˜ìŠ¤ ê· í˜•**ì„ ìœ ì§€í•˜ë©´ì„œ ì…”í”Œí•©ë‹ˆë‹¤.

```python
def _shuffle_gradients(self, activations, grads):
    # 1. ê° í´ë¼ì´ì–¸íŠ¸ê°€ í´ë˜ìŠ¤ë‹¹ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ê°œìˆ˜ ê³„ì‚°
    keep_limit = {cid: N // C for cid, N in N_per_cid.items()}
    
    # 2. ì´ˆê³¼ë¶„ì€ donor_queueì— ê¸°ë¶€, í•œë„ ë‚´ëŠ” ê³ ì •
    for cid in cid2pos:
        for lbl, positions in lbl2pos.items():
            keep_cnt = min(len(positions), limit)
            fixed_pos.update(positions[:keep_cnt])
            for p in positions[keep_cnt:]:
                donor_queue[lbl].append((grad[p], cid))
    
    # 3. ë¶€ì¡±í•œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì˜ gradient ë¶„ë°°
    for lbl in range(C):
        for cid in clients:
            while need > 0 and queue:
                tensor, donor_id = queue.popleft()
                if donor_id != cid:  # ìì‹ ì˜ gradientëŠ” ì œì™¸
                    grad[empty_pos[cid].pop()] = tensor
```

**ê²°ê³¼**: ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ê· ë“±í•œ í´ë˜ìŠ¤ ë¶„í¬ì˜ gradientë¥¼ ë°›ìŒ

#### 10.3.3 Average (`-gss average -gaw 0.5`)

ì›ë³¸ gradientì™€ ì „ì—­ í‰ê· ì„ í˜¼í•©í•©ë‹ˆë‹¤.

```python
weight = 0.5  # gradient_average_weight
mean_grad = grad.mean(dim=0, keepdim=True)
grad = (1 - weight) * grad + weight * mean_grad
# ê²°ê³¼: 50% ì›ë³¸ + 50% ì „ì—­ í‰ê· 
```

#### 10.3.4 Average Adaptive Alpha (`-gss average_adaptive_alpha -aab 2.0`)

**ê°€ì¥ ì •êµí•œ ë°©ì‹**ìœ¼ë¡œ, cosine similarityì— ë”°ë¼ ë™ì ìœ¼ë¡œ í˜¼í•© ë¹„ìœ¨ì„ ê²°ì •í•©ë‹ˆë‹¤.

```python
# Step 1: Cosine Similarity ê³„ì‚°
cos_sim = (grad Â· mean_grad) / (||grad|| Ã— ||mean_grad||)

# Step 2: Sigmoidë¡œ alpha ê³„ì‚°
alpha_dynamic = sigmoid(Î² Ã— cos_sim)

# Step 3: ì ì‘ì  í˜¼í•©
grad = alpha_dynamic * grad + (1 - alpha_dynamic) * mean_grad
```

**í•´ì„**:
```
cos_sim â‰ˆ 1  (í‰ê· ê³¼ ìœ ì‚¬)   â†’ alpha â‰ˆ 0.88 â†’ 88% ì›ë³¸ ìœ ì§€
cos_sim â‰ˆ 0  (ì§êµ)          â†’ alpha â‰ˆ 0.50 â†’ 50-50 í˜¼í•©
cos_sim â‰ˆ -1 (í‰ê· ê³¼ ë°˜ëŒ€)   â†’ alpha â‰ˆ 0.12 â†’ 88% í‰ê·  ì‚¬ìš©

ì§ê´€: ì¢‹ì€ ë°©í–¥ì˜ gradientëŠ” ìœ ì§€, ë‚˜ìœ ë°©í–¥ì€ í‰ê· ìœ¼ë¡œ ìˆ˜ì •
```

---

## 11. USFL Selector

### 11.1 3ë‹¨ê³„ ì„ íƒ ì•Œê³ ë¦¬ì¦˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: Missing Labels + Temp_min í•„í„°                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  for each candidate:                                                â”‚
â”‚    missing_after = count(labels with 0 samples after adding cand)  â”‚
â”‚    temp_min = min(samples per label after adding cand)             â”‚
â”‚                                                                     â”‚
â”‚  Sort by: (missing_after ASC, temp_min DESC)                        â”‚
â”‚  â†’ ëˆ„ë½ ë ˆì´ë¸” ìµœì†Œí™” ìš°ì„ , ë™ì¼ ì‹œ ìµœì†Œ í´ë˜ìŠ¤ í¬ê¸° ìµœëŒ€í™”            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 2: Top-N í›„ë³´ ì„ íƒ                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  primary_candidates = top_n(sorted_candidates)  # default: 3        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 3: Freshness ì ìˆ˜ ê¸°ë°˜ ìµœì¢… ì„ íƒ (use_fresh_scoring ì‹œ)       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  for each primary_candidate:                                        â”‚
â”‚    predicted_usage = simulate_trimming(current + candidate)        â”‚
â”‚    freshness_score = calculate_freshness(predicted, usage_history) â”‚
â”‚                                                                     â”‚
â”‚  Select: argmax(freshness_score)                                    â”‚
â”‚  â†’ ê³¼ê±°ì— ëœ ì‚¬ìš©ëœ ë°ì´í„°ë¥¼ ê°€ì§„ í´ë¼ì´ì–¸íŠ¸ ìš°ì„                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 Freshness Score ê³„ì‚°

```python
def _calculate_freshness_score(self, predicted_counts, usage_history):
    score = 0.0
    for label, amount_to_use in predicted_counts.items():
        # Exponential Binsë¡œ ì €ì¥ëœ ì‚¬ìš© ì´ë ¥
        for bin_key in sorted(usage_bins.keys()):
            available = usage_bins[bin_key]
            can_use = min(amount_to_use, available)
            
            # ì‚¬ìš© íšŸìˆ˜ê°€ ì ì„ìˆ˜ë¡ ë†’ì€ ê°€ì¤‘ì¹˜
            avg_usage = (bin_min + bin_max) / 2.0
            weight = decay_rate ** avg_usage
            
            score += can_use * weight
    return score
```

**ì§ê´€**: 0ë²ˆ ì‚¬ìš©ëœ ë°ì´í„° > 1ë²ˆ ì‚¬ìš©ëœ ë°ì´í„° > 2ë²ˆ ì‚¬ìš©ëœ ë°ì´í„° ...

---

## 12. USFL Aggregator

### 12.1 Label-Capped Weighting

ê¸°ì¡´ FedAvgëŠ” ë‹¨ìˆœ ë°ì´í„° ì–‘ ë¹„ë¡€ ê°€ì¤‘ì¹˜ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, USFLì€ **ë ˆì´ë¸”ë³„ ê¸°ì—¬ë„**ë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤.

```python
class USFLAggregator:
    def aggregate(self, models, params):
        # 1. ë ˆì´ë¸”ë³„ ìµœëŒ€ ê°€ì¤‘ì¹˜: w_hat[l] = n_l / N
        max_weight = {lab: total_per_label[lab] / global_total for lab in labels}
        
        # 2. ë””ë°”ì´ìŠ¤ë³„ ê°€ì¤‘ì¹˜ ê³„ì‚°
        for dist in label_dists:
            weight_j = 0.0
            for lab in labels:
                share = dist.get(lab, 0) / total_per_label[lab]  # ê¸°ì—¬ìœ¨
                weight_j += max_weight[lab] * share
            device_weights.append(weight_j)
        
        # 3. ê°€ì¤‘ í‰ê·  ì§‘ê³„
        for model, w in zip(models, device_weights):
            for k, p in model.state_dict().items():
                agg_state[k] += p.float() * w
```

**ìˆ˜ì‹**:
```
w_j = Î£_l (n_l / N) Ã— (n_l,j / n_l)
    = Î£_l (n_l,j / N)

where:
  n_l     = ì „ì²´ ë°ì´í„°ì—ì„œ ë ˆì´ë¸” lì˜ ê°œìˆ˜
  n_l,j   = í´ë¼ì´ì–¸íŠ¸ jì˜ ë ˆì´ë¸” l ê°œìˆ˜
  N       = ì „ì²´ ë°ì´í„° ê°œìˆ˜
```

---

## 13. Dynamic Batch Scheduler

### 13.1 ëª©í‘œ

ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì˜ ë°ì´í„°ë¥¼ **ì™„ì „íˆ ì†Œì§„**í•˜ë©´ì„œ ë°°ì¹˜ í¬ê¸°ë¥¼ ê· ë“±í•˜ê²Œ ìœ ì§€

### 13.2 ì•Œê³ ë¦¬ì¦˜

```python
def create_schedule(B: int, C_list: list[int]):
    """
    B: ëª©í‘œ ë°°ì¹˜ í¬ê¸°
    C_list: ê° í´ë¼ì´ì–¸íŠ¸ì˜ ë°ì´í„° ì–‘
    
    Returns: (k, schedule)
      k: iteration ìˆ˜
      schedule[iter][client] = batch_size
    """
    # Phase 1: Bì— ê°€ì¥ ê°€ê¹Œìš´ sumì„ ë§Œë“œëŠ” k ì°¾ê¸°
    for k_candidate in range(1, max(C_list) + 3):
        current_sum = sum(ceil(c / k_candidate) for c in C_list)
        if abs(current_sum - B) < min_diff:
            best_k = k_candidate
    
    # Phase 2: ê° iterationì˜ ë°°ì¹˜ í¬ê¸° ë¶„ë°°
    for round_num in range(1, k + 1):
        # ë‚¨ì€ ë°ì´í„°ì— ë¹„ë¡€í•˜ì—¬ í• ë‹¹
        quotas = [(rd / total_remaining) * target_batch_size for rd in remaining]
        consumption = [min(floor(q), rd) for q, rd in zip(quotas, remaining)]
```

### 13.3 í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì²˜ë¦¬

```python
# usfl_model_trainer.py
if my_schedule:
    for batch_idx, current_batch_size in enumerate(my_schedule):
        if current_batch_size == 0:
            # ë¹ˆ activation ì „ì†¡ (ì„œë²„ ë™ê¸°í™” ìœ ì§€)
            await self.api.submit_activations({"outputs": empty, ...})
            await self.api.wait_for_gradients()
            continue
        
        # ìŠ¤ì¼€ì¤„ì— ë”°ë¥¸ ë°°ì¹˜ ìˆ˜ë™ êµ¬ì„±
        batch_data = []
        for _ in range(current_batch_size):
            data, target = next(dataloader_iterator)
            batch_data.append(data)
```

---

## 14. Cumulative Usage Tracking

### 14.1 Exponential Bins êµ¬ì¡°

ë©”ëª¨ë¦¬ íš¨ìœ¨ì„ ìœ„í•´ ì‚¬ìš© íšŸìˆ˜ë¥¼ ì§€ìˆ˜ì  êµ¬ê°„ìœ¼ë¡œ ê·¸ë£¹í™”í•©ë‹ˆë‹¤.

```
Bin êµ¬ì¡°:
  bin 0 â†’ 0íšŒ ì‚¬ìš©
  bin 1 â†’ 1íšŒ ì‚¬ìš©
  bin 2 â†’ 2-3íšŒ ì‚¬ìš©
  bin 4 â†’ 4-7íšŒ ì‚¬ìš©
  bin 8 â†’ 8-15íšŒ ì‚¬ìš©
  ...

cumulative_usage[client_id][label] = {
    0: 500,  # 0íšŒ ì‚¬ìš© ë°ì´í„° 500ê°œ
    1: 200,  # 1íšŒ ì‚¬ìš© ë°ì´í„° 200ê°œ
    2: 100,  # 2-3íšŒ ì‚¬ìš© ë°ì´í„° 100ê°œ
}
```

### 14.2 ì—…ë°ì´íŠ¸ ë¡œì§

```python
# usfl_stage_organizer.py _post_round()
for client_id, class_counts in self.client_label_counts.items():
    for class_label, amount_to_use in class_counts.items():
        total_amount = amount_to_use * effective_epochs
        
        for current_bin in sorted_bins:
            can_move = min(remaining_to_move, usage_bins[current_bin])
            
            # í˜„ì¬ bin â†’ ìƒˆë¡œìš´ binìœ¼ë¡œ ì´ë™
            new_usage = avg_current_usage + effective_epochs
            target_bin = get_exponential_bin(new_usage)
            
            usage_bins[current_bin] -= can_move
            usage_bins[target_bin] += can_move
```

---

# Part 4: ì‹¤í–‰ ë° í™œìš©

## 15. ì„¤ì • íŒŒë¼ë¯¸í„° ë ˆí¼ëŸ°ìŠ¤

### 15.1 í•„ìˆ˜ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ì„¤ëª… | ì˜ˆì‹œ |
|----------|------|------|
| `-d` | ë°ì´í„°ì…‹ | `cifar10`, `fmnist`, `mnist` |
| `-m` | ëª¨ë¸ | `resnet18`, `alexnet`, `vgg11` |
| `-M` | ë°©ë²• | `usfl`, `sfl`, `fl` |
| `-le` | ë¡œì»¬ ì—í­ | `5` |
| `-gr` | ê¸€ë¡œë²Œ ë¼ìš´ë“œ | `100` |
| `-nc` | ì´ í´ë¼ì´ì–¸íŠ¸ ìˆ˜ | `100` |
| `-ncpr` | ë¼ìš´ë“œë‹¹ í´ë¼ì´ì–¸íŠ¸ ìˆ˜ | `10` |

### 15.2 USFL ì „ìš© íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ì„¤ëª… | ê¸°ë³¸ê°’ |
|----------|------|--------|
| `-bstrat` | Balancing ì „ëµ | `trimming` |
| `-btarget` | Target ê¸°ì¤€ | `mean` |
| `-gs` | Gradient Shuffle í™œì„±í™” | - |
| `-gss` | Gradient Shuffle ì „ëµ | - |
| `-gaw` | Average ê°€ì¤‘ì¹˜ | `0.5` |
| `-aab` | Adaptive Alpha Beta | `2.0` |
| `-udbs` | Dynamic Batch Scheduler | - |
| `-ucu` | Cumulative Usage | - |
| `-ufs` | Fresh Scoring | - |
| `-udf` | Usage Decay Factor | `0.99` |
| `-fdr` | Freshness Decay Rate | `0.5` |

### 15.3 SFL íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ì„¤ëª… | í•„ìˆ˜ ì¡°ê±´ |
|----------|------|----------|
| `-ss` | Split Strategy | `layer_name` |
| `-sl` | Split Layer | ëª¨ë¸ì— ë”°ë¼ ë‹¤ë¦„ |
| `-sr` | Split Ratio | `ratio_*` ì „ëµ ì‹œ |

### 15.4 ë°ì´í„° ë¶„í¬ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ì„¤ëª… | ê¸°ë³¸ê°’ |
|----------|------|--------|
| `-distr` | Distributer | `dirichlet` |
| `-diri-alpha` | Dirichlet Alpha | `0.5` |
| `-lpc` | í´ë¼ì´ì–¸íŠ¸ë‹¹ ë ˆì´ë¸” ìˆ˜ | `2` |
| `-mrs` | ìµœì†Œ ìƒ˜í”Œ ìˆ˜ | `10` |

---

## 16. ì‹¤í—˜ ì‹¤í–‰ ê°€ì´ë“œ

### 16.1 ê¸°ë³¸ USFL ì‹¤í—˜

```python
# simulation.pyì—ì„œ USFL_OPTIONS ìˆ˜ì •
USFL_OPTIONS = {
    "A": {
        "dataset": "cifar10",
        "model": "resnet18",
        "batch_size": "256",
        "labels_per_client": "2",
        "dirichlet_alpha": "0.3",
        "gradient_shuffle": "true",
        "gradient_shuffle_strategy": "random",
        "use_dynamic_batch_scheduler": "true",
        "balancing_strategy": "target",
        "balancing_target": "mean",
        "split_layer": "layer1.1.bn2",
    },
}
```

### 16.2 ì‹¤í–‰

```bash
# Simulation ì‹¤í–‰
python simulation.py

# íŠ¹ì • GPU ì‚¬ìš©
CUDA_VISIBLE_DEVICES=0 python simulation.py
```

### 16.3 ê¶Œì¥ ì„¤ì • ì¡°í•©

```bash
# ê¸°ë³¸ USFL (ë¹ ë¥¸ ì‹¤í—˜)
-M usfl -s usfl -bstrat target -btarget mean -gs -gss random -udbs

# ê³ ê¸‰ USFL (ìµœê³  ì„±ëŠ¥)
-M usfl -s usfl -aggr usfl \
-bstrat target -btarget mean \
-gs -gss average_adaptive_alpha -aab 2.0 \
-udbs -ucu -ufs -fdr 0.5

# Extreme Non-IID ì‹¤í—˜
-distr shard_dirichlet -diri-alpha 0.1 -lpc 2 -mrs 10
```

---

## ğŸ“ ìš”ì•½

| êµ¬ì„±ìš”ì†Œ | USFLì˜ í•´ê²°ì±… |
|----------|--------------|
| **í´ë˜ìŠ¤ ë¶ˆê· í˜•** | Data Balancing (Target ì „ëµ) |
| **Gradient í¸í–¥** | Gradient Shuffle (Inplace/Adaptive) |
| **í´ë¼ì´ì–¸íŠ¸ ì„ íƒ** | USFL Selector (Missing Label + Freshness) |
| **ëª¨ë¸ ì§‘ê³„** | USFL Aggregator (Label-capped) |
| **ë°ì´í„° ë‚­ë¹„** | Dynamic Batch Scheduler |
| **ë°ì´í„° ì‹ ì„ ë„** | Cumulative Usage Tracking |

---

*ì´ ë¬¸ì„œëŠ” SFL Frameworkì™€ USFL ê¸°ë²•ì˜ ì™„ì „í•œ ì´í•´ë¥¼ ìœ„í•œ ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤.*
*ìµœì¢… ì—…ë°ì´íŠ¸: 2026-01-10*
